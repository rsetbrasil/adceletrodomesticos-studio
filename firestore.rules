
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Regra geral: permite leitura pública, mas escrita apenas para usuários autenticados.
    match /{document=**} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // Acesso mais detalhado por coleção
    match /products/{productId} {
      allow read: if true;
      allow write: if request.auth != null; // Apenas usuários logados podem alterar produtos
    }

    match /categories/{categoryId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    match /orders/{orderId} {
      // Apenas o usuário que fez o pedido ou um admin pode ler. Escrita apenas por admins.
      allow read: if request.auth != null && (request.auth.uid == resource.data.customer.uid || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'gerente']);
      allow write: if request.auth != null; // Simplificado: qualquer usuário logado pode criar/atualizar um pedido (checkout)
    }

    match /users/{userId} {
      // Usuários só podem ler e escrever seus próprios dados, a menos que sejam admin.
      allow read, write: if request.auth != null && (request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

     match /config/{configId} {
        allow read: if true;
        allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
     }
     
     match /auditLogs/{logId} {
        allow read, write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'gerente'];
     }
     
     match /commissionPayments/{paymentId} {
        allow read, write: if request.auth != null;
     }
  }
}
